version: v1.0
name: multi-arch-builds
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1

auto_cancel:
  running:
    when: "branch != 'master'"

execution_time_limit:
  hours: 1

queue:
  - when: "branch != 'master'"
    processing: parallel

blocks:
  - name: "Build Native Executable (MacOS AMD64)"
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-macos-13-5-amd64
      prologue:
        commands_file: build_native_executable_prologue.sh
      env_vars:
        - name: OS
          value: macos
        - name: ARCH
          value: amd64
      jobs:
        - name: "Build Native Executable (MacOS AMD64)"
          commands:
            - make mvn-package-native
            - make ci-sign-notarize-macos-executable
      epilogue:
        on_pass:
          commands_file: build_native_executable_epilogue.sh

  - name: "Build Native Executable (MacOS ARM64)"
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-macos-13-5-arm64
      prologue:
        commands_file: build_native_executable_prologue.sh
      env_vars:
        - name: OS
          value: macos
        - name: ARCH
          value: arm64
      jobs:
        - name: "Build Native Executable (MacOS ARM64)"
          commands:
            - make mvn-package-native
            - make ci-sign-notarize-macos-executable
      epilogue:
        on_pass:
          commands_file: build_native_executable_epilogue.sh

  - name: "Build Native Executable (Linux AMD64)"
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-amd64-1
      prologue:
        commands_file: build_native_executable_prologue.sh
      env_vars:
        - name: OS
          value: linux
        - name: ARCH
          value: amd64
      jobs:
        - name: "Build Native Executable (Linux AMD64)"
          commands:
            - make mvn-package-native
      epilogue:
        on_pass:
          commands_file: build_native_executable_epilogue.sh

  - name: "Build Native Executable (Linux ARM64)"
    dependencies: []
    task:
      agent:
        machine:
          type: s1-prod-ubuntu20-04-arm64-1
      prologue:
        commands_file: build_native_executable_prologue.sh
      env_vars:
        - name: OS
          value: linux
        - name: ARCH
          value: arm64
      jobs:
        - name: "Build Native Executable (Linux ARM64)"
          commands:
            - make mvn-package-native
      epilogue:
        on_pass:
          commands_file: build_native_executable_epilogue.sh

  - name: "Upload native executables to GitHub Releases"
    run:
      when: "branch =~ '.*' and change_in('/.versions/ide-sidecar-version.txt', {pipeline_file: 'ignore', default_branch: 'main'})"
    dependencies:
      - "Build Native Executable (MacOS AMD64)"
      - "Build Native Executable (MacOS ARM64)"
      - "Build Native Executable (Linux AMD64)"
      - "Build Native Executable (Linux ARM64)"
    task:
      prologue:
        commands:
          - checkout
          - artifact pull workflow native-executables/
      jobs:
        - name: "Upload native executables to GitHub Releases"
          commands:
            - make upload-artifacts-to-github-release
